<div class="region-goods-details row">
    <div class="region-inner col-sm-2">课程目录设置</div>
    <div class="region-goods-right col-sm-10">
        <div class="form-group">
            <label class="col-sm-2 control-label">是否开启按章购买</label>
            <div class="col-sm-9 col-xs-12">
                <label class="radio-inline"><input type="radio" name="is_chapter_buy" value="0" {if empty($item['is_chapter_buy'])}checked="true"{/if}/> 未开启</label>
                <label class="radio-inline"><input type="radio" name="is_chapter_buy" value="1" {if $item['is_chapter_buy'] == 1}checked="true"{/if}   /> 已开启</label>
                <span class="help-block">是否开启按章购买开关，控制课程按章是否可以单独购买观看</span>
            </div>
        </div>

        <div class="form-group">
            <label class="col-sm-2 control-label">是否开启按节购买</label>
            <div class="col-sm-9 col-xs-12">
                <label class="radio-inline"><input type="radio" name="is_single_buy" value="0" {if empty($item['is_single_buy'])}checked="true"{/if}/> 未开启</label>
                <label class="radio-inline"><input type="radio" name="is_single_buy" value="1" {if $item['is_single_buy'] == 1}checked="true"{/if}   /> 已开启</label>
                <span class="help-block">是否开启按节购买开关，控制课程按节是否可以单独购买观看</span>
            </div>
        </div>

        <div class="form-group">
            <label class="col-sm-2 control-label">显示类型</label>
            <div class="col-sm-9 col-xs-12">
                <label class="radio-inline">
                    <input type="radio" name="style" value="0" {if empty($item['style'])}checked="true"{/if}/> 默认列表
                </label>
                <label class="radio-inline">
                    <input type="radio" name="style" value="1" {if $item['style'] == 1}checked="true"{/if}  /> 图文列表
                </label>
                <span class="help-block">是否开启按节购买开关，控制课程按节是否可以单独购买观看</span>
            </div>
        </div>

    </div>
</div>

<div class="region-goods-details row">
    <!-- <div class="region-goods-left col-sm-2">章节列表</div> -->
    <div class="region-goods-right col-sm-12">
            
        <div id="tboption" style="padding-left:15px; ">

            <div id="chapters" class="ui-sortable">
                {foreach $chapters as $key => $chapter}
                    {include file='web/goods/index/tpl/chapter'}
                {/foreach}
            </div>

            <table class="table">
                <tbody>
                    <tr>
                        <td>
                            <h4>
                                <a href="javascript:;" class="btn btn-primary" id="add-chapter" onclick="addChapter()" style="margin-top:10px;margin-bottom:10px;" title="添加章节"><i class="fa fa-plus"></i> 添加新章节</a>
                            </h4>
                        </td>
                    </tr>
                </tbody>
            </table>

        </div>

    </div>
</div>

<script type="text/javascript">
    require(['jquery.ui'],function(){
        $('#chapters').sortable({
            stop: function(){
                refreshOptions();
            }
        });

        $('.chapter_item_items').sortable({
            handle:'.fa-arrows',
            stop: function(){
                refreshOptions();
            }
        });

    });

    require(['jquery', 'util'], function ($, util) {

        $('.btn-select-chapter').unbind('click').click(function () {
            let imgitem = $(this).closest('.img-item');
            util.image('', function (data) {
                // console.log(data)
                imgitem.find('img').attr('src', data['url']);
                imgitem.find('input').val(data['fileurl']);
            });
        });

        $('.btn-select-pic').unbind('click').click(function () {
            let imgitem = $(this).closest('.img-item');
            util.image('', function (data) {
                imgitem.find('img').attr('src', data['url']);
                imgitem.find('input').val(data['fileurl']);
            });
        });
    });

    function updateDuration(This){
        // let time = $(This).val();

        let time = time.replace("：","/");
        let hour = time.split(':')[0];
        let min = time.split(':')[1];
        let sec = time.split(':')[2];
        let s = Number(hour*3600) + Number(min*60) + Number(sec);
        let prevS = $(This).parent().prev().find('input').val();

        $(This).val(time);

        if( !prevS ){
            $(This).parent().prev().find('input').val(s);
        }
        // console.log(time)
        // console.log(s)
    }

    function upChapterItem(This){
        // console.log(132)
        let obj = $(This).parent().parent();
        obj.prev().insertAfter(obj);
    } 

    function downChapterItem(This){
        let obj = $(This).parent().parent();
        obj.next().insertBefore(obj);
    }

    let numbers = ['一','二','三','四','五','六','七','八','九','十','十一','十二','十三','十四','十五','十六','十七','十八','十九','二十','二十一','二十二','二十三','二十四','二十五','二十六','二十七','二十八','二十九','三十']

    function refreshOptions(){
        $(".chapter_item").each(function(i){
            // console.log(numbers[i]);
            $(this).find(".input-group-addon").eq(0).text('第'+numbers[i]+'章')
        });
    }

    // 添加新章
    function addChapter(){
        let len = $(".chapter_item").length;

        $("#add-chapter").html("正在处理...").attr("disabled", "true").toggleClass("btn-primary");
        let url = "{:webUrl('web.goods.index/tpl',array('tpl'=>'chapter'))}"+ "&goodsid={$id}"+"&num="+(len+1);
        $.ajax({
            "url": url,
            success:function(data){
                $("#add-chapter").html('<i class="fa fa-plus"></i> 添加新章节').removeAttr("disabled").toggleClass("btn-primary");
                $('#chapters').append(data);
                let len = $(".add-chapter_item").length -1;
                $(".chapter_title:eq(" +len+ ")").focus();
            }
        });
    }

    // 添加小节
    function addChapterItem(chapterid){
        $("#add-chapter_item-" + chapterid).html("正在处理...").attr("disabled", "true");
        let chapter_item_length = $("#chapter_" + chapterid + " .chapter_item_title").length;
        let url = "{:webUrl('web.goods.index/tpl',array('tpl'=>'chapter_item'))}" + "&goodsid={$id}&chapterid=" + chapterid + "&num=" + (chapter_item_length + 1);
        $.ajax({
            "url": url,
            success:function(data){
                $("#add-chapter_item-" + chapterid).html('<i class="fa fa-plus"></i> 添加小节').removeAttr("disabled");
                $('#chapter_item_' + chapterid).append(data);
                let len =  chapter_item_length - 1;
                $("#chapter_" + chapterid + " .chapter_item_title:eq(" +len+ ")").focus();
            }
        });
    }

    // 删除章节
    function removeChapter(chapterid){
        console.log(chapterid);
        if (confirm('确认要删除此章节?')){
            $("#chapter_" + chapterid).remove();
        }
    }

    // 是否显示小节
    function showItem(obj){
        let show = $(obj).get(0).checked?"1":"0";
        $(obj).parents('.chapter_item_item').find('.chapter_item_show:eq(0)').val(show);
    }

    // 是否上架小节
    function statusItem(obj){
        let show = $(obj).get(0).checked?"1":"0";
        $(obj).parents('.chapter_item_item').find('.chapter_item_status:eq(0)').val(show);
    }

    // 是否推荐小节
    function isrecommandItem(obj){
        let show = $(obj).get(0).checked?"1":"0";
        $(obj).parents('.chapter_item_item').find('.chapter_item_isrecommand:eq(0)').val(show);
    }

    // 是否体验课
    function setPublic(obj){
        let show = $(obj).get(0).checked?"1":"0";
        $(obj).parents('.chapter_item_item').find('.chapter_item_ispublic:eq(0)').val(show);
    }

    // 是否公开课
    function setPublicShow(obj){
        let show = $(obj).get(0).checked?"1":"0";
        $(obj).parents('.chapter_item_item').find('.chapter_item_ispublic_show:eq(0)').val(show);
    }

    // 是否上架章节
    function statusChapter(obj){
        let show = $(obj).get(0).checked?"1":"0";
        $(obj).parents('.chapter_item').find('.chapter_status:eq(0)').val(show);
    }

    // 删除小节
    function removeChapterItem(obj){
        if (confirm('确认要删除此小节?')){
            $(obj).closest('.chapter_item_item').remove();
        }
    }

</script>