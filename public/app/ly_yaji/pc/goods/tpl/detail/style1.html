<link rel="stylesheet" href="{$moduleAttachUrl}/static/components/swiper/swiper.min.css">

<!-- 文创 -->
<div class="goods-main row">

    <div class="goods-info flex">

        <div class="preview-wrap">

            <div class="preview">

                <div class="main-img">
                    <div class="cloudzoom-box">
                        <img class="cloudzoom" src="{$goodsInfo['thumbs'][0]}" data-cloudzoom="zoomSizeMode:'image',zoomImage: '{$goodsInfo['thumbs'][0]}',autoInside: 30" title="" width="350" onerror="this.src='{$moduleAttachUrl}/static/images/default-img.png'">
                    </div>
                </div>

                <div class="spec-list swiper">
                    <ul class="spec-items flex swiper-wrapper">
                        <!--image 小图-->
                        <!--zoomImage 原图-->
                        {foreach $goodsInfo['thumbs'] as $key => $thumb}
                        <li class="swiper-slide" style="width: 70px"><img class="cloudzoom-gallery" src="{$thumb}" data-cloudzoom="useZoom:'.cloudzoom',image:'{$thumb}',zoomImage:'{$thumb}'" onerror="this.src='{$moduleAttachUrl}/static/images/default-img.png'"></li>
                        {/foreach}
                    </ul>
                </div>

            </div>

            <div class="preview-bottom flex-row">
                <div class="btn" id="addFavorite"><i class="iconfont">{$isFavorite ? '&#xe612;' : '&#xe617;'}</i><span>{$isFavorite ? '已收藏' : '收藏'}</span></div>
                <div class="btn" id="contact-service"><i class="iconfont">&#xe618;</i><span>联系客服</span></div>
            </div>

        </div>

        <div class="goods-info-wrap flex-column">

            <div class="choose-info">

                <div class="sku-name">
                    {$goodsInfo['title']}
                </div>

                <div class="flex-row-center money-wrapper">
                    <div class="money-wrap">
                        <del>原价：￥{$goodsInfo['originalprice']}</del>
                        <div class="flex-row-center">
                            <div class="price">￥<span>{$goodsInfo['marketprice']}</span></div>
                        </div>
                    </div>
                    <div class="sales flex-column flex-center row-center-wrapper">
                        <div class="num">{$goodsInfo['sales']}</div>
                        <div>销量</div>
                    </div>
                </div>

                <!--<div class="price-wrap">
                    <div class="p-price">
                        <span class="unit">¥</span>
                        <span class="price">{$goodsInfo['marketprice']}</span>
                    </div>
                </div>-->
                <!--<div class="delivery-wrap flex">
                    <div class="delivery-name">配送:</div>
                    <div class="delivery-address">
                        <div class="address">浙江省杭州市西湖区转塘街道大美创意园0110室</div>
                        <div class="expenses">快递:免运费</div>
                    </div>
                </div>-->
                <div class="buy-num-wrap flex">
                    <div class="buy-num-name">数量:</div>
                    <div class="buy-num-box flex">
                        <div class="decrease minus disabled"><i class="iconfont">&#xe60c;</i></div>
                        <div class="input-box">
                            <input type="tel" id="quantity" value="1" size="3" maxlength="6" class="input-text">
                        </div>
                        <div class="increase plus"><i class="iconfont">&#xe621;</i></div>
                    </div>
                </div>
            </div>

            <div class="choose-options">
                <div class="btn btn-primary {if $goodsInfo['total'] <= 0}disabled{/if}" id="buyConfirm"><span>立即购买</span></div>
                <div class="btn btn-default {if $goodsInfo['total'] <= 0}disabled{/if}" id="addCart"><span>加入购物车</span></div>

                <!--<div class="btn btn-default" id="addFavorite">
                    <i class="iconfont">{$isFavorite ? '&#xe612;' : '&#xe617;'}</i>
                    <span>{$isFavorite ? '已收藏' : '收藏'}</span>
                </div>-->

                <!--<div class="btn btn-default" id="contact-service"><span>联系客服</span></div>-->
            </div>

        </div>

    </div>

    <input type="hidden" id="isFavorite" value="{$isFavorite}">

    <!--商品详情-->

    <div class="detail-content-title">
        <div class="title">宝贝详情</div>
    </div>

    <div class="detail-content-wrap">

        <div class="goods-detail-content">
            {$goodsInfo['content']|raw}
        </div>

    </div>

    <!--商品详情 end -->
    {include file='pc/goods/tpl/contact'}

</div>

<script>
    require(['jquery', 'cloudzoom', 'ajax', 'tip'], function () {
        CloudZoom.quickStart();

        // 图片切换效果
        $(".spec-items li>img").first().addClass('cloudzoom-gallery-active');
        $('.spec-items').find('li').mouseover(function () {
            $(this).first().children('img').addClass("cloudzoom-gallery-active");
            $(this).first().siblings().children('img').removeClass("cloudzoom-gallery-active");
        });

        // 立即购买
        $("#buyConfirm").click(function () {
            let goodsTotal = parseInt("{$goodsInfo['total']}");
            if (goodsTotal > 0) {
                location.href = "{:url('order/confirm')}?id={$goodsInfo['id']}&total=" + parseInt($('#quantity').val());
            }
        });

        // 二维码弹窗
        $('#contact-service').click(function () {
            $('.qrcode').show();
        });
        $('.close,.qrcode-bg').click(function () {
            $('.qrcode').hide();
        });

        // 加入购物车
        $("#addCart").click(function () {
            let goodsTotal = parseInt("{$goodsInfo['total']}");
            if (goodsTotal > 0) {
                let goodsId = "{$goodsInfo['id']}";
                let url = "{:url('cart/add')}";
                let total = parseInt($('#quantity').val());
                let cartTotalObj = $('#rtoobar_cart_count');
                let cartTotal = parseInt(cartTotalObj.text());

                ajax.post(url, {goodsid: goodsId, total: total}, (json) => {
                    tip.success("加入购物车成功");

                    cartTotalObj.text(cartTotal + total);
                    cartTotalObj.removeClass('hide');
                });
            }
        });

        // 加入收藏
        $("#addFavorite").click(function () {
            let isFavoriteObj = $('#isFavorite');
            let isFavorite = parseInt(isFavoriteObj.val());
            let goodsId = "{$goodsInfo['id']}";
            let url = "{:url('favorite/add')}";

            isFavoriteObj.val(isFavorite ? 0 : 1);
            console.log('isFavorite', isFavoriteObj.val());

            if (!isFavorite) {
                $(this).html($(`<i class="iconfont">&#xe612;</i><span>已收藏</span>`));
            } else {
                $(this).html($(`<i class="iconfont">&#xe617;</i><span>收藏</span>`));
            }

            ajax.post(url, {goodsid: goodsId}, (json) => {

                $('#isFavorite').val(isFavorite ? 0 : 1);

                if (isFavorite) {
                    tip.success("取消收藏成功");
                } else {
                    tip.success("收藏成功");
                }
            });
        });

        $(".decrease").click(() => {
            let quantity = $('#quantity');
            let total = parseInt(quantity.val()) - 1;
            quantity.val(total > 0 ? total : 1);
            if (total <= 1) {
                $(".decrease").addClass('disabled');
            }
        });

        $(".increase").click(() => {
            let quantity = $('#quantity');
            let total = parseInt(quantity.val()) + 1;
            let goodsTotal = parseInt("{$goodsInfo['total']}");

            if (total > goodsTotal) {
                tip.msgbox.err(`最多添加${goodsTotal}件商品`);
                return false;
            }

            quantity.val(total);
            if (total > 1) {
                $(".decrease").removeClass('disabled');
            }
        });

        require(['swiper'], function (Swiper) {
            new Swiper('.swiper', {
                slidesPerView: 'auto',
            });
        });

    });
</script>